<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.report.mapper.ReportMapper">
    
    <!-- 获取总库存数量 -->
    <select id="getTotalStockQuantity" resultType="Long">
        SELECT COALESCE(SUM(quantity), 0) FROM stock_info
    </select>

    <!-- 获取总库存价值 -->
    <select id="getTotalStockValue" resultType="Double">
        SELECT COALESCE(SUM(si.quantity * mi.purchase_price), 0) 
        FROM stock_info si
        LEFT JOIN material_info mi ON si.material_id = mi.material_id
    </select>

    <!-- 获取仓库数量 -->
    <select id="getWarehouseCount" resultType="Long">
        SELECT COUNT(*) FROM warehouse WHERE status = 1
    </select>

    <!-- 获取原料种类数 -->
    <select id="getMaterialCount" resultType="Long">
        SELECT COUNT(DISTINCT material_id) FROM stock_info
    </select>

    <!-- 获取预警数量 -->
    <select id="getAlertCount" resultType="Long">
        SELECT COUNT(*) FROM stock_info 
        WHERE quantity &lt;= alert_threshold
    </select>

    <!-- 按仓库统计库存 -->
    <select id="getStockByWarehouse" resultType="java.util.HashMap">
        SELECT 
            w.warehouse_id,
            w.warehouse_name,
            COALESCE(SUM(si.quantity), 0) as total_quantity,
            COUNT(DISTINCT si.material_id) as material_count
        FROM warehouse w
        LEFT JOIN stock_info si ON w.warehouse_id = si.warehouse_id
        WHERE w.status = 1
        GROUP BY w.warehouse_id, w.warehouse_name
        ORDER BY total_quantity DESC
    </select>

    <!-- 获取库存预警列表 -->
    <select id="getStockAlert" resultType="java.util.HashMap">
        SELECT 
            si.stock_id,
            si.material_id,
            mi.material_name,
            si.quantity,
            si.alert_threshold,
            si.location,
            w.warehouse_name
        FROM stock_info si
        LEFT JOIN material_info mi ON si.material_id = mi.material_id
        LEFT JOIN warehouse w ON si.warehouse_id = w.warehouse_id
        WHERE si.quantity &lt;= si.alert_threshold
        ORDER BY (si.quantity - si.alert_threshold) ASC
    </select>

    <!-- 获取盘点总数 -->
    <select id="getTotalChecks" resultType="Long">
        SELECT COUNT(*) FROM stock_check
    </select>

    <!-- 获取进行中的盘点数 -->
    <select id="getOngoingChecks" resultType="Long">
        SELECT COUNT(*) FROM stock_check WHERE status = 1
    </select>

    <!-- 获取已完成的盘点数 -->
    <select id="getCompletedChecks" resultType="Long">
        SELECT COUNT(*) FROM stock_check WHERE status = 2
    </select>

    <!-- 获取总差异数量 -->
    <select id="getTotalDiscrepancy" resultType="Long">
        SELECT COALESCE(SUM(discrepancy_count), 0) FROM stock_check
    </select>

    <!-- 获取盘点明细统计 -->
    <select id="getCheckDetails" resultType="java.util.HashMap">
        SELECT 
            sc.check_id,
            sc.check_no,
            sc.check_date,
            sc.total_count,
            sc.discrepancy_count,
            w.warehouse_name,
            CASE sc.status
                WHEN 1 THEN '进行中'
                WHEN 2 THEN '已完成'
                WHEN 3 THEN '已取消'
                ELSE '未知'
            END as status_name
        FROM stock_check sc
        LEFT JOIN warehouse w ON sc.warehouse_id = w.warehouse_id
        ORDER BY sc.check_date DESC
        LIMIT 10
    </select>

    <!-- 获取原料使用分析 -->
    <select id="getMaterialUsage" resultType="java.util.HashMap">
        SELECT 
            mi.material_id,
            mi.material_name,
            mi.specification,
            COALESCE(SUM(si.quantity), 0) as total_quantity,
            COUNT(DISTINCT si.warehouse_id) as warehouse_count,
            COALESCE(SUM(pf.quantity), 0) as used_in_products
        FROM material_info mi
        LEFT JOIN stock_info si ON mi.material_id = si.material_id
        LEFT JOIN product_formula pf ON mi.material_id = pf.material_id
        GROUP BY mi.material_id, mi.material_name, mi.specification
        ORDER BY total_quantity DESC
    </select>

    <!-- 获取产品总数 -->
    <select id="getTotalProducts" resultType="Long">
        SELECT COUNT(*) FROM product_info
    </select>

    <!-- 获取上架产品数 -->
    <select id="getOnSaleProducts" resultType="Long">
        SELECT COUNT(*) FROM product_info WHERE status = 1
    </select>

    <!-- 获取热销产品数 -->
    <select id="getHotProducts" resultType="Long">
        SELECT COUNT(*) FROM product_info WHERE is_hot = 1 AND status = 1
    </select>

    <!-- 按分类统计产品 -->
    <select id="getProductByCategory" resultType="java.util.HashMap">
        SELECT 
            pc.category_id,
            pc.category_name,
            COUNT(pi.product_id) as product_count,
            COALESCE(SUM(CASE WHEN pi.status = 1 THEN 1 ELSE 0 END), 0) as on_sale_count
        FROM product_category pc
        LEFT JOIN product_info pi ON pc.category_id = pi.category_id
        WHERE pc.status = 1
        GROUP BY pc.category_id, pc.category_name
        ORDER BY product_count DESC
    </select>

    <!-- 获取订单总数 -->
    <select id="getTotalOrders" resultType="Long">
        SELECT COUNT(*) FROM order_main
    </select>

    <!-- 获取待处理订单数 -->
    <select id="getPendingOrders" resultType="Long">
        SELECT COUNT(*) FROM order_main WHERE status != 8
    </select>

    <!-- 获取已完成订单数 -->
    <select id="getCompletedOrders" resultType="Long">
        SELECT COUNT(*) FROM order_main WHERE status = 8
    </select>

    <!-- 获取本月订单金额 -->
    <select id="getMonthOrderAmount" resultType="Double">
        SELECT COALESCE(SUM(actual_amount), 0) 
        FROM order_main 
        WHERE DATE_FORMAT(completion_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
    </select>

    <!-- 按客户统计订单 -->
    <select id="getOrderByCustomer" resultType="java.util.HashMap">
        SELECT 
            om.customer_id,
            c.customer_name,
            COUNT(om.order_id) as order_count,
            COALESCE(SUM(om.total_amount), 0) as total_amount,
            COALESCE(SUM(CASE WHEN om.status = 4 THEN 1 ELSE 0 END), 0) as completed_count
        FROM order_main om
        LEFT JOIN customer c ON om.customer_id = c.customer_id
        GROUP BY om.customer_id, c.customer_name
        ORDER BY order_count DESC
        LIMIT 10
    </select>

    <!-- 获取采购订单总数 -->
    <select id="getTotalPurchases" resultType="Long">
        SELECT COUNT(*) FROM purchase_order
    </select>

    <!-- 获取待处理采购订单数 -->
    <select id="getPendingPurchases" resultType="Long">
        SELECT COUNT(*) FROM purchase_order WHERE status &lt; 4
    </select>

    <!-- 获取已完成采购订单数 -->
    <select id="getCompletedPurchases" resultType="Long">
        SELECT COUNT(*) FROM purchase_order WHERE status &gt; 3
    </select>

    <!-- 获取本月采购金额 -->
    <select id="getMonthPurchaseAmount" resultType="Double">
        SELECT COALESCE(SUM(total_amount), 0) 
        FROM purchase_order 
        WHERE DATE_FORMAT(create_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
    </select>

    <!-- 按供应商统计采购 -->
    <select id="getPurchaseBySupplier" resultType="java.util.HashMap">
        SELECT 
            po.supplier_id,
            s.supplier_name,
            COUNT(po.purchase_id) as purchase_count,
            COALESCE(SUM(po.total_amount), 0) as total_amount,
            COALESCE(SUM(CASE WHEN po.status = 4 THEN 1 ELSE 0 END), 0) as completed_count
        FROM purchase_order po
        LEFT JOIN supplier s ON po.supplier_id = s.supplier_id
        GROUP BY po.supplier_id, s.supplier_name
        ORDER BY purchase_count DESC
        LIMIT 10
    </select>

</mapper>

